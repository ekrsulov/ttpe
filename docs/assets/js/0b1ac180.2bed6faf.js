"use strict";(self.webpackChunkttpe_docs=self.webpackChunkttpe_docs||[]).push([[5863],{6264:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"architecture/overview","title":"Architecture Overview","description":"TTPE is architected as a modular, extensible vector graphics editor. This document provides a high-level view of the system\'s design, key abstractions, and architectural decisions.","source":"@site/docs/architecture/overview.md","sourceDirName":"architecture","slug":"/architecture/overview","permalink":"/ttpe/docs/architecture/overview","draft":false,"unlisted":false,"editUrl":"https://github.com/ekrsulov/ttpe/tree/main/doc/docs/architecture/overview.md","tags":[],"version":"current","lastUpdatedBy":"Ernesto Krsulovic","lastUpdatedAt":1762144179000,"frontMatter":{"id":"overview","title":"Architecture Overview","sidebar_label":"Overview"},"sidebar":"docs","previous":{"title":"Settings Panel","permalink":"/ttpe/docs/app-structure/settings-panel"},"next":{"title":"Diagrams","permalink":"/ttpe/docs/architecture/diagrams"}}');var r=s(4848),t=s(8453);const l={id:"overview",title:"Architecture Overview",sidebar_label:"Overview"},a="Architecture Overview",c={},d=[{value:"Design Goals",id:"design-goals",level:2},{value:"1. Extensibility",id:"1-extensibility",level:3},{value:"2. Maintainability",id:"2-maintainability",level:3},{value:"3. Type Safety",id:"3-type-safety",level:3},{value:"4. Performance",id:"4-performance",level:3},{value:"5. Testability",id:"5-testability",level:3},{value:"System Context",id:"system-context",level:2},{value:"Container Architecture",id:"container-architecture",level:2},{value:"Key Abstractions",id:"key-abstractions",level:2},{value:"1. Plugin Manager",id:"1-plugin-manager",level:3},{value:"2. Canvas Event Bus",id:"2-canvas-event-bus",level:3},{value:"3. Plugin Definition",id:"3-plugin-definition",level:3},{value:"4. Zustand Store Slices",id:"4-zustand-store-slices",level:3},{value:"5. Canvas Services",id:"5-canvas-services",level:3},{value:"Data Flow",id:"data-flow",level:2},{value:"User Interaction Flow",id:"user-interaction-flow",level:3},{value:"Plugin Registration Flow",id:"plugin-registration-flow",level:3},{value:"State Management Strategy",id:"state-management-strategy",level:2},{value:"Store Organization",id:"store-organization",level:3},{value:"Undo/Redo",id:"undoredo",level:3},{value:"Persistence Strategy",id:"persistence-strategy",level:2},{value:"Security &amp; Sandboxing",id:"security--sandboxing",level:2},{value:"Current State",id:"current-state",level:3},{value:"Considerations",id:"considerations",level:3},{value:"Future: Plugin Sandboxing",id:"future-plugin-sandboxing",level:3},{value:"Performance Optimizations",id:"performance-optimizations",level:2},{value:"1. React Optimizations",id:"1-react-optimizations",level:3},{value:"2. Canvas Rendering",id:"2-canvas-rendering",level:3},{value:"3. Event Handling",id:"3-event-handling",level:3},{value:"4. Data Structures",id:"4-data-structures",level:3},{value:"Versioning &amp; Migration",id:"versioning--migration",level:2},{value:"Current Version: 0.0.0",id:"current-version-000",level:3},{value:"Future Migration Strategy",id:"future-migration-strategy",level:3},{value:"Glossary",id:"glossary",level:2},{value:"Constraints &amp; Trade-offs",id:"constraints--trade-offs",level:2},{value:"Design Constraints",id:"design-constraints",level:3},{value:"Trade-offs",id:"trade-offs",level:3},{value:"Next Steps",id:"next-steps",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"architecture-overview",children:"Architecture Overview"})}),"\n",(0,r.jsx)(n.p,{children:"TTPE is architected as a modular, extensible vector graphics editor. This document provides a high-level view of the system's design, key abstractions, and architectural decisions."}),"\n",(0,r.jsx)(n.h2,{id:"design-goals",children:"Design Goals"}),"\n",(0,r.jsx)(n.h3,{id:"1-extensibility",children:"1. Extensibility"}),"\n",(0,r.jsx)(n.p,{children:"Every feature should be pluggable. The core provides infrastructure; plugins provide functionality."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Achievement"}),": All tools (select, pencil, shapes, text, transforms) are plugins. The core canvas knows nothing about specific tools."]}),"\n",(0,r.jsx)(n.h3,{id:"2-maintainability",children:"2. Maintainability"}),"\n",(0,r.jsx)(n.p,{children:"Code should be organized by feature, not by layer. Related code lives together."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Achievement"}),": Plugin directory structure groups slices, UI, and logic together (e.g., ",(0,r.jsx)(n.code,{children:"plugins/pencil/"})," contains everything pencil-related)."]}),"\n",(0,r.jsx)(n.h3,{id:"3-type-safety",children:"3. Type Safety"}),"\n",(0,r.jsx)(n.p,{children:"TypeScript should catch errors at compile time, not runtime."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Achievement"}),": Strict typing for events, store slices, plugin APIs, and all public interfaces."]}),"\n",(0,r.jsx)(n.h3,{id:"4-performance",children:"4. Performance"}),"\n",(0,r.jsx)(n.p,{children:"Large canvases (1000+ elements) should remain responsive."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Achievement"}),": Optimized rendering, debounced operations, memoized computations, and efficient data structures."]}),"\n",(0,r.jsx)(n.h3,{id:"5-testability",children:"5. Testability"}),"\n",(0,r.jsx)(n.p,{children:"Features should be testable in isolation and as integrated systems."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Achievement"}),": E2E tests with Playwright, modular slices, and injectable dependencies."]}),"\n",(0,r.jsx)(n.h2,{id:"system-context",children:"System Context"}),"\n",(0,r.jsx)(n.mermaid,{value:'graph TB\n    User["\ud83d\udc64 Designer/Artist<br/><small>Creates and edits<br/>vector graphics</small>"]\n    \n    TTPE["<b>TTPE Application</b><br/><small>Web-based vector editor</small>"]\n    \n    Browser["\ud83c\udf10 Web Browser<br/><small>Chrome, Firefox, Safari</small>"]\n    Storage["\ud83d\udcbe Local Storage<br/><small>Persists canvas state</small>"]\n    WASM["\u26a1 WASM Modules<br/><small>Potrace for text-to-curves</small>"]\n    \n    User --\x3e|"Interacts with"| TTPE\n    TTPE --\x3e|"Runs in"| Browser\n    TTPE --\x3e|"Persists to/loads from"| Storage\n    TTPE --\x3e|"Uses for heavy computation"| WASM\n    \n    style User fill:#08427b,stroke:#052e56,color:#fff\n    style TTPE fill:#1168bd,stroke:#0b4884,color:#fff\n    style Browser fill:#999,stroke:#666,color:#fff\n    style Storage fill:#999,stroke:#666,color:#fff\n    style WASM fill:#999,stroke:#666,color:#fff'}),"\n",(0,r.jsx)(n.h2,{id:"container-architecture",children:"Container Architecture"}),"\n",(0,r.jsx)(n.mermaid,{value:'graph TB\n    subgraph Presentation["\ud83c\udfa8 Presentation Layer"]\n        UI["UI Components<br/><small>Canvas, Sidebars,<br/>Toolbars, Panels</small>"]\n    end\n    \n    subgraph Processing["\u2699\ufe0f Processing Layer"]\n        EventBus["Event Bus<br/><small>Pub/sub for<br/>canvas events</small>"]\n        Plugins["Plugin System<br/><small>Extensible tools<br/>and features</small>"]\n        Services["Canvas Services<br/><small>Zoom, smooth brush,<br/>listeners</small>"]\n    end\n    \n    subgraph State["\ud83d\udcbe State Layer"]\n        Store["State Management<br/><small>Zustand with slices</small>"]\n        Persistence["Persistence<br/><small>LocalStorage<br/>auto-save</small>"]\n    end\n    \n    UI --\x3e|"Emits pointer/<br/>touch events"| EventBus\n    UI -.->|"Subscribes to<br/>state changes"| Store\n    \n    EventBus --\x3e|"Notifies"| Plugins\n    EventBus --\x3e|"Notifies"| Services\n    \n    Plugins --\x3e|"Reads/writes<br/>state"| Store\n    Services --\x3e|"Reads/writes<br/>state"| Store\n    \n    Store <--\x3e|"Auto-save/<br/>restore"| Persistence\n    \n    style UI fill:#1168bd,stroke:#0b4884,color:#fff\n    style EventBus fill:#2d9cdb,stroke:#1a7db8,color:#fff\n    style Plugins fill:#27ae60,stroke:#1e8449,color:#fff\n    style Services fill:#27ae60,stroke:#1e8449,color:#fff\n    style Store fill:#e67e22,stroke:#ca6510,color:#fff\n    style Persistence fill:#95a5a6,stroke:#7f8c8d,color:#fff'}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'\n## Component Architecture\n\n```mermaid\ngraph TB\n    subgraph "Presentation Layer"\n        App[App.tsx]\n        Canvas[Canvas Component]\n        Sidebar[Sidebar]\n        Toolbar[Action Bars]\n    end\n    \n    subgraph "State Layer"\n        Store[Canvas Store]\n        BaseSlice[Base Slice]\n        ViewportSlice[Viewport Slice]\n        SelectionSlice[Selection Slice]\n        PluginSlices[Plugin Slices...]\n    end\n    \n    subgraph "Plugin System"\n        PM[Plugin Manager]\n        Registry[Plugin Registry]\n        APIs[Plugin APIs]\n    end\n    \n    subgraph "Event System"\n        EventBus[Event Bus]\n        Listeners[Event Listeners]\n    end\n    \n    subgraph "Plugins"\n        Select[Select Plugin]\n        Pencil[Pencil Plugin]\n        Text[Text Plugin]\n        Transform[Transform Plugin]\n        Edit[Edit Plugin]\n        More[10+ More Plugins]\n    end\n    \n    App --\x3e Canvas\n    App --\x3e Sidebar\n    App --\x3e Toolbar\n    \n    Canvas --\x3e EventBus\n    EventBus --\x3e PM\n    PM --\x3e Registry\n    PM --\x3e APIs\n    \n    Registry --\x3e Select\n    Registry --\x3e Pencil\n    Registry --\x3e Text\n    Registry --\x3e Transform\n    Registry --\x3e Edit\n    Registry --\x3e More\n    \n    Select --\x3e Store\n    Pencil --\x3e Store\n    Text --\x3e Store\n    Transform --\x3e Store\n    Edit --\x3e Store\n    \n    Store --\x3e BaseSlice\n    Store --\x3e ViewportSlice\n    Store --\x3e SelectionSlice\n    Store --\x3e PluginSlices\n    \n    EventBus --\x3e Listeners\n    Listeners --\x3e Store\n'})}),"\n",(0,r.jsx)(n.h2,{id:"key-abstractions",children:"Key Abstractions"}),"\n",(0,r.jsx)(n.h3,{id:"1-plugin-manager",children:"1. Plugin Manager"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Location"}),": ",(0,r.jsx)(n.code,{children:"src/utils/pluginManager.ts"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose"}),": Central registry for plugins, handles lifecycle, shortcuts, APIs, and canvas services."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Responsibilities"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Register/unregister plugins"}),"\n",(0,r.jsxs)(n.li,{children:["Manage plugin APIs via ",(0,r.jsx)(n.code,{children:"createApi"})]}),"\n",(0,r.jsx)(n.li,{children:"Coordinate event bus subscriptions"}),"\n",(0,r.jsx)(n.li,{children:"Handle keyboard shortcuts"}),"\n",(0,r.jsx)(n.li,{children:"Manage canvas services (zoom, smooth brush, etc.)"}),"\n",(0,r.jsx)(n.li,{children:"Provide canvas layer rendering"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Key Methods"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"class PluginManager {\n  register(plugin: PluginDefinition): void\n  unregister(pluginId: string): void\n  getPluginApi<T>(pluginId: string): T | undefined\n  callPluginApi(pluginId, methodName, ...args): any\n  registerInteractionHandler(pluginId, eventType, handler): () => void\n  executeHandler(toolName, event, point, target, helpers): void\n  activateCanvasService(serviceId, context): () => void\n  getCanvasLayers(): CanvasLayerContribution[]\n  getPanels(toolName): PluginUIContribution[]\n  getOverlays(toolName): React.ComponentType[]\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-canvas-event-bus",children:"2. Canvas Event Bus"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Location"}),": ",(0,r.jsx)(n.code,{children:"src/canvas/CanvasEventBusContext.tsx"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose"}),": Type-safe pub/sub for canvas interactions."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Event Types"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"pointerdown"})," - Canvas pointer press"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"pointermove"})," - Canvas pointer movement"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"pointerup"})," - Canvas pointer release"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"keyboard"})," - Keyboard events"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"wheel"})," - Scroll/zoom events"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Usage"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Subscribe\nconst unsubscribe = eventBus.subscribe('pointerdown', (payload) => {\n  console.log(payload.point, payload.activePlugin);\n});\n\n// Emit\neventBus.emit('pointermove', {\n  event, point, target, activePlugin, helpers, state\n});\n\n// Cleanup\nunsubscribe();\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3-plugin-definition",children:"3. Plugin Definition"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Location"}),": ",(0,r.jsx)(n.code,{children:"src/types/plugins.ts"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose"}),": Schema for plugin contributions."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Structure"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface PluginDefinition<TStore> {\n  id: string;\n  metadata: {\n    label: string;\n    icon?: React.ComponentType;\n    cursor?: string;\n  };\n  handler?: (event, point, target, context) => void;\n  keyboardShortcuts?: CanvasShortcutMap;\n  overlays?: PluginUIContribution[];\n  canvasLayers?: CanvasLayerContribution[];\n  panels?: PluginUIContribution[];\n  actions?: PluginActionContribution[];\n  slices?: PluginSliceFactory<TStore>[];\n  createApi?: PluginApiFactory<TStore>;\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"4-zustand-store-slices",children:"4. Zustand Store Slices"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Location"}),": ",(0,r.jsx)(n.code,{children:"src/store/canvasStore.ts"})," (core), ",(0,r.jsx)(n.code,{children:"src/plugins/*/slice.ts"})," (plugin slices)"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose"}),": Modular state management. Each plugin contributes a slice."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Slice Pattern"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export interface MyPluginSlice {\n  myData: DataType[];\n  mySettings: SettingsType;\n  updateMyData: (data: DataType[]) => void;\n}\n\nexport const createMyPluginSlice: PluginSliceFactory = (set, get, api) => ({\n  state: {\n    myData: [],\n    mySettings: defaultSettings,\n    updateMyData: (data) => set({ myData: data }),\n  },\n  cleanup: () => {\n    // Optional cleanup\n  }\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"5-canvas-services",children:"5. Canvas Services"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Location"}),": ",(0,r.jsx)(n.code,{children:"src/canvas/listeners/*"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose"}),": Persistent background services that operate independently of active tools."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Examples"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"ZoomListener"})," - Manages zoom gestures"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"SmoothBrushListener"})," - Applies smoothing to brush strokes"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"AddPointListener"})," - Detects and adds points to paths"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Interface"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface CanvasService<TState> {\n  id: string;\n  create: (context: CanvasServiceContext) => CanvasServiceInstance<TState>;\n}\n\ninterface CanvasServiceInstance<TState> {\n  update?: (state: TState) => void;\n  dispose: () => void;\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"data-flow",children:"Data Flow"}),"\n",(0,r.jsx)(n.h3,{id:"user-interaction-flow",children:"User Interaction Flow"}),"\n",(0,r.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant User\n    participant Canvas\n    participant EventBus\n    participant PluginManager\n    participant Plugin\n    participant Store\n    participant UI\n    \n    User->>Canvas: Click/drag\n    Canvas->>EventBus: emit('pointerdown', payload)\n    EventBus->>PluginManager: Notify subscribers\n    PluginManager->>Plugin: Execute handler(event, point, context)\n    Plugin->>Store: Update state (set)\n    Store->>UI: Trigger re-render\n    UI->>Canvas: Render updated elements"}),"\n",(0,r.jsx)(n.h3,{id:"plugin-registration-flow",children:"Plugin Registration Flow"}),"\n",(0,r.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant Main\n    participant PluginManager\n    participant Store\n    participant EventBus\n    participant ShortcutRegistry\n    \n    Main->>PluginManager: register(plugin)\n    PluginManager->>PluginManager: Validate & store in registry\n    \n    alt Plugin has slices\n        PluginManager->>Store: Register slices\n        Store->>Store: Merge slice state\n    end\n    \n    alt Plugin has createApi\n        PluginManager->>PluginManager: Initialize plugin API\n    end\n    \n    alt Plugin has shortcuts\n        PluginManager->>ShortcutRegistry: Bind shortcuts\n    end\n    \n    alt Plugin has handler\n        PluginManager->>EventBus: Subscribe to pointerdown\n    end\n    \n    PluginManager--\x3e>Main: Plugin ready"}),"\n",(0,r.jsx)(n.h2,{id:"state-management-strategy",children:"State Management Strategy"}),"\n",(0,r.jsx)(n.h3,{id:"store-organization",children:"Store Organization"}),"\n",(0,r.jsx)(n.p,{children:"The Zustand store is composed of:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Base Slice"})," (",(0,r.jsx)(n.code,{children:"src/store/slices/baseSlice.ts"}),")"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Elements (paths, groups)"}),"\n",(0,r.jsx)(n.li,{children:"Active plugin"}),"\n",(0,r.jsx)(n.li,{children:"Panel visibility"}),"\n",(0,r.jsx)(n.li,{children:"Global settings"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Viewport Slice"})," (",(0,r.jsx)(n.code,{children:"src/store/slices/viewportSlice.ts"}),")"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Pan offset"}),"\n",(0,r.jsx)(n.li,{children:"Zoom level"}),"\n",(0,r.jsx)(n.li,{children:"View bounds"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Selection Slice"})," (",(0,r.jsx)(n.code,{children:"src/store/slices/selectionSlice.ts"}),")"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Selected element IDs"}),"\n",(0,r.jsx)(n.li,{children:"Selection helpers"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Plugin Slices"})," (dynamic, contributed by plugins)"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Plugin-specific state"}),"\n",(0,r.jsx)(n.li,{children:"Plugin actions"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"undoredo",children:"Undo/Redo"}),"\n",(0,r.jsxs)(n.p,{children:["Managed by ",(0,r.jsx)(n.strong,{children:"Zundo"})," middleware:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"History depth: 50 steps"}),"\n",(0,r.jsx)(n.li,{children:"Cooldown: 100ms between snapshots"}),"\n",(0,r.jsxs)(n.li,{children:["Selective state: Only ",(0,r.jsx)(n.code,{children:"elements"}),", ",(0,r.jsx)(n.code,{children:"selectedIds"}),", and plugin data are tracked"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Configuration"}),": ",(0,r.jsx)(n.code,{children:"src/store/canvasStore.ts"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const useCanvasStore = create<CanvasStore>()(\n  temporal(\n    (...args) => ({\n      ...createBaseSlice(...args),\n      ...createViewportSlice(...args),\n      ...createSelectionSlice(...args),\n      // Plugin slices registered dynamically\n    }),\n    {\n      limit: 50,\n      cooldown: 100,\n      partialize: (state) => ({\n        elements: state.elements,\n        selectedIds: state.selectedIds,\n        // Plugin state...\n      })\n    }\n  )\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"persistence-strategy",children:"Persistence Strategy"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Location"}),": ",(0,r.jsx)(n.code,{children:"src/store/slices/baseSlice.ts"})]}),"\n",(0,r.jsxs)(n.p,{children:["State is automatically persisted to ",(0,r.jsx)(n.code,{children:"localStorage"})," on every update (debounced)."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Saved Keys"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"elements"}),": All canvas elements"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"settings"}),": User preferences (grid, snap, precision)"]}),"\n",(0,r.jsx)(n.li,{children:"Plugin-specific state (varies by plugin)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Not Saved"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Viewport (pan/zoom)"}),"\n",(0,r.jsx)(n.li,{children:"Transient UI state (hover, drag, selection rectangle)"}),"\n",(0,r.jsx)(n.li,{children:"Undo history"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"security--sandboxing",children:"Security & Sandboxing"}),"\n",(0,r.jsx)(n.h3,{id:"current-state",children:"Current State"}),"\n",(0,r.jsx)(n.p,{children:"Plugins run in the same JavaScript context with full access to the store and DOM."}),"\n",(0,r.jsx)(n.h3,{id:"considerations",children:"Considerations"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Trusted Plugins Only"}),": Only ship vetted plugins in ",(0,r.jsx)(n.code,{children:"CORE_PLUGINS"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Third-Party Plugins"}),": Not currently supported; would require iframe sandboxing or Web Workers"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"XSS Protection"}),": All user input (text, SVG) is sanitized via React's built-in escaping"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"future-plugin-sandboxing",children:"Future: Plugin Sandboxing"}),"\n",(0,r.jsx)(n.p,{children:"For third-party plugins:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Web Workers"}),": Run plugin logic in a worker thread"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Message Passing"}),": Use ",(0,r.jsx)(n.code,{children:"postMessage"})," for store interactions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"API Whitelist"}),": Only expose safe APIs to workers"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"CSP Headers"}),": Enforce Content Security Policy"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"performance-optimizations",children:"Performance Optimizations"}),"\n",(0,r.jsx)(n.h3,{id:"1-react-optimizations",children:"1. React Optimizations"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Memoization"}),": ",(0,r.jsx)(n.code,{children:"useMemo"}),", ",(0,r.jsx)(n.code,{children:"useCallback"})," on all expensive computations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Render Counting"}),": Optional render count badges in dev mode"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Selective Subscriptions"}),": Zustand selectors only subscribe to needed state"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Good: Only re-renders when selectedIds changes\nconst selectedIds = useCanvasStore(state => state.selectedIds);\n\n// Bad: Re-renders on ANY store change\nconst store = useCanvasStore();\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-canvas-rendering",children:"2. Canvas Rendering"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Layer Composition"}),": Separate SVG layers for static vs. dynamic content"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Transform Caching"}),": Computed bounds are memoized"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Conditional Rendering"}),": Overlays only render when active"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"3-event-handling",children:"3. Event Handling"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Debouncing"}),": Undo snapshots, persistence saves"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Throttling"}),": Smooth brush calculations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Passive Listeners"}),": Scroll/touch events use ",(0,r.jsx)(n.code,{children:"{ passive: true }"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"4-data-structures",children:"4. Data Structures"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Maps for Lookups"}),": O(1) access for elements by ID"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Sets for Selection"}),": O(1) membership checks"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Immutable Updates"}),": Zustand ensures referential equality checks work"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"versioning--migration",children:"Versioning & Migration"}),"\n",(0,r.jsx)(n.h3,{id:"current-version-000",children:"Current Version: 0.0.0"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Assumption"}),": Pre-1.0, no formal versioning yet."]}),"\n",(0,r.jsx)(n.h3,{id:"future-migration-strategy",children:"Future Migration Strategy"}),"\n",(0,r.jsx)(n.p,{children:"When introducing breaking changes:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Version Detection"}),": Store ",(0,r.jsx)(n.code,{children:"version"})," key in persisted state"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Migration Functions"}),": Map old structure to new structure"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Fallback"}),": If migration fails, prompt user to reset"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Example"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"function migrateState(state: any): CanvasStore {\n  if (!state.version || state.version < 2) {\n    return migrateV1ToV2(state);\n  }\n  return state;\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"glossary",children:"Glossary"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Term"}),(0,r.jsx)(n.th,{children:"Definition"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Plugin"})}),(0,r.jsx)(n.td,{children:"Self-contained module extending TTPE functionality"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Slice"})}),(0,r.jsx)(n.td,{children:"Modular piece of Zustand store state"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Event Bus"})}),(0,r.jsx)(n.td,{children:"Pub/sub system for canvas interactions"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Canvas Service"})}),(0,r.jsx)(n.td,{children:"Background service independent of active tool"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Layer Contribution"})}),(0,r.jsx)(n.td,{children:"SVG rendering provided by a plugin"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Plugin API"})}),(0,r.jsxs)(n.td,{children:["Public methods exposed by a plugin via ",(0,r.jsx)(n.code,{children:"createApi"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Handler"})}),(0,r.jsx)(n.td,{children:"Function executed on pointer events when plugin is active"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Overlay"})}),(0,r.jsx)(n.td,{children:"React component rendered above the canvas"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Panel"})}),(0,r.jsx)(n.td,{children:"Sidebar UI contributed by a plugin"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Action"})}),(0,r.jsx)(n.td,{children:"Contextual button/menu item contributed by a plugin"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"constraints--trade-offs",children:"Constraints & Trade-offs"}),"\n",(0,r.jsx)(n.h3,{id:"design-constraints",children:"Design Constraints"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Browser-Only"}),": No server-side rendering or Node.js runtime"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Single Canvas"}),": Multiple canvases not supported (could be added)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"SVG Output"}),": Raster export requires additional libraries"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"No Collaborative Editing"}),": No remote sync infrastructure (WebSocket, CRDT, etc.)"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"trade-offs",children:"Trade-offs"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Decision"}),(0,r.jsx)(n.th,{children:"Pro"}),(0,r.jsx)(n.th,{children:"Con"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Plugin-based"}),(0,r.jsx)(n.td,{children:"Highly extensible"}),(0,r.jsx)(n.td,{children:"More abstraction layers"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Zustand over Redux"}),(0,r.jsx)(n.td,{children:"Simpler, less boilerplate"}),(0,r.jsx)(n.td,{children:"Less ecosystem tooling"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Chakra UI"}),(0,r.jsx)(n.td,{children:"Fast setup, theming"}),(0,r.jsx)(n.td,{children:"Bundle size larger than headless"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"LocalStorage"}),(0,r.jsx)(n.td,{children:"No backend needed"}),(0,r.jsx)(n.td,{children:"Limited to ~5MB, single-user"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Event bus"}),(0,r.jsx)(n.td,{children:"Decouples plugins"}),(0,r.jsx)(n.td,{children:"Adds indirection"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.a,{href:"./diagrams",children:"Architecture Diagrams"})}),": Detailed Mermaid diagrams for every subsystem"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.a,{href:"../plugins/overview",children:"Plugin System"})}),": Deep dive into plugin development"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.a,{href:"../event-bus/overview",children:"Event Bus"})}),": Comprehensive event reference"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.a,{href:"../api/canvas-store",children:"Canvas Store API"})}),": Complete state management guide"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>a});var i=s(6540);const r={},t=i.createContext(r);function l(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);