"use strict";(self.webpackChunkttpe_docs=self.webpackChunkttpe_docs||[]).push([[289],{3549:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"app-structure/canvas","title":"Canvas","description":"The Canvas is the core rendering and interaction surface of TTPE. It\'s an infinite 2D workspace where users create, edit, and manipulate vector graphics using an SVG-based rendering system with React components.","source":"@site/docs/app-structure/canvas.md","sourceDirName":"app-structure","slug":"/app-structure/canvas","permalink":"/ttpe/docs/app-structure/canvas","draft":false,"unlisted":false,"editUrl":"https://github.com/ekrsulov/ttpe/tree/main/doc/docs/app-structure/canvas.md","tags":[],"version":"current","lastUpdatedBy":"Ernesto Krsulovic","lastUpdatedAt":1762144179000,"frontMatter":{"id":"canvas","title":"Canvas","sidebar_label":"Canvas"},"sidebar":"docs","previous":{"title":"Overview","permalink":"/ttpe/docs/app-structure/overview"},"next":{"title":"Action Bars","permalink":"/ttpe/docs/app-structure/actionbars"}}');var r=s(4848),i=s(8453);const o={id:"canvas",title:"Canvas",sidebar_label:"Canvas"},a="Canvas",l={},c=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Canvas Coordinate Systems",id:"canvas-coordinate-systems",level:2},{value:"1. <strong>Screen Coordinates</strong> (Viewport Space)",id:"1-screen-coordinates-viewport-space",level:3},{value:"2. <strong>Canvas Coordinates</strong> (SVG World Space)",id:"2-canvas-coordinates-svg-world-space",level:3},{value:"3. <strong>Element Local Coordinates</strong>",id:"3-element-local-coordinates",level:3},{value:"Rendering Pipeline",id:"rendering-pipeline",level:2},{value:"Rendering Phases",id:"rendering-phases",level:3},{value:"Renderer Registry",id:"renderer-registry",level:3},{value:"Event Handling",id:"event-handling",level:2},{value:"Viewport Management",id:"viewport-management",level:2},{value:"Canvas State",id:"canvas-state",level:2},{value:"Performance Optimizations",id:"performance-optimizations",level:2},{value:"1. <strong>React SVG Reconciliation</strong>",id:"1-react-svg-reconciliation",level:3},{value:"2. <strong>Zustand Granular Selectors</strong>",id:"2-zustand-granular-selectors",level:3},{value:"3. <strong>Memoized Contexts</strong>",id:"3-memoized-contexts",level:3},{value:"4. <strong>Ref-Based Callbacks</strong>",id:"4-ref-based-callbacks",level:3},{value:"5. <strong>Dynamic Canvas Size</strong>",id:"5-dynamic-canvas-size",level:3},{value:"6. <strong>Temporal State Subscription</strong>",id:"6-temporal-state-subscription",level:3},{value:"Canvas Overlays (Plugin Layers)",id:"canvas-overlays-plugin-layers",level:2},{value:"Plugin Layer System",id:"plugin-layer-system",level:3},{value:"Common Plugin Overlays",id:"common-plugin-overlays",level:3},{value:"Integration with Plugins",id:"integration-with-plugins",level:2},{value:"1. <strong>Event Bus Subscriptions</strong>",id:"1-event-bus-subscriptions",level:3},{value:"2. <strong>Canvas Layer Context</strong>",id:"2-canvas-layer-context",level:3},{value:"3. <strong>Canvas Store Access</strong>",id:"3-canvas-store-access",level:3},{value:"4. <strong>Renderer Registry</strong>",id:"4-renderer-registry",level:3},{value:"Canvas Component Props",id:"canvas-component-props",level:2},{value:"File Structure",id:"file-structure",level:2},{value:"Usage Example",id:"usage-example",level:2},{value:"Related Documentation",id:"related-documentation",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"For Plugin Developers",id:"for-plugin-developers",level:3},{value:"For Contributors",id:"for-contributors",level:3}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"canvas",children:"Canvas"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.strong,{children:"Canvas"})," is the core rendering and interaction surface of TTPE. It's an infinite 2D workspace where users create, edit, and manipulate vector graphics using an ",(0,r.jsx)(n.strong,{children:"SVG-based rendering system"})," with React components."]}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsxs)(n.p,{children:["The Canvas component (",(0,r.jsx)(n.code,{children:"/src/canvas/Canvas.tsx"}),") is responsible for:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Rendering all canvas elements"})," as SVG (paths, groups, shapes, text)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Handling viewport transformations"})," (pan, zoom via SVG viewBox)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Managing user interactions"})," (pointer/touch events, gesture recognition)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Coordinating with plugins"})," via event bus for tool-specific behavior"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Providing layered overlays"})," through plugin system"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The canvas uses a ",(0,r.jsx)(n.strong,{children:"modular hook-based architecture"})," with centralized control:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Canvas Controller"}),": Centralized state and operations via Context"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Event Bus"}),": Plugin communication system"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Custom Hooks"}),": 24+ specialized hooks for different concerns"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Plugin Layers"}),": Plugins render their own overlays on top of elements"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,r.jsx)(n.mermaid,{value:"graph TB\n    Canvas[Canvas.tsx] --\x3e EventBus[CanvasEventBusContext]\n    Canvas --\x3e Controller[CanvasControllerProvider]\n    Canvas --\x3e Services[CanvasServicesProvider]\n    Canvas --\x3e Stage[CanvasStage]\n    \n    Controller --\x3e Hooks[Custom Hooks]\n    Hooks --\x3e Selection[useSelectionController]\n    Hooks --\x3e Transform[useCanvasTransformControls]\n    Hooks --\x3e Shape[useCanvasShapeCreation]\n    Hooks --\x3e Viewport[useViewportController]\n    Hooks --\x3e Geometry[useCanvasGeometry]\n    Hooks --\x3e EventHandlers[useCanvasEventHandlers]\n    \n    Stage --\x3e Layers[CanvasLayers]\n    Layers --\x3e Elements[Render Elements]\n    Layers --\x3e PluginLayers[Plugin Overlays]\n    \n    EventBus --\x3e Plugins[Plugin System]\n    Plugins --\x3e Select[Select Plugin]\n    Plugins --\x3e Edit[Edit Plugin]\n    Plugins --\x3e Pencil[Pencil Plugin]"}),"\n",(0,r.jsx)(n.h2,{id:"canvas-coordinate-systems",children:"Canvas Coordinate Systems"}),"\n",(0,r.jsxs)(n.p,{children:["TTPE uses ",(0,r.jsx)(n.strong,{children:"multiple coordinate systems"})," for different purposes:"]}),"\n",(0,r.jsxs)(n.h3,{id:"1-screen-coordinates-viewport-space",children:["1. ",(0,r.jsx)(n.strong,{children:"Screen Coordinates"})," (Viewport Space)"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Origin: Top-left corner of the browser window"}),"\n",(0,r.jsx)(n.li,{children:"Units: CSS pixels"}),"\n",(0,r.jsx)(n.li,{children:"Used for: Pointer/touch events, UI positioning"}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"2-canvas-coordinates-svg-world-space",children:["2. ",(0,r.jsx)(n.strong,{children:"Canvas Coordinates"})," (SVG World Space)"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Origin: Transformed by SVG viewBox (pan/zoom)"}),"\n",(0,r.jsx)(n.li,{children:"Units: SVG user units (1 unit = 1px at zoom level 1.0)"}),"\n",(0,r.jsx)(n.li,{children:"Used for: Element positions, rendering, geometric calculations"}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"3-element-local-coordinates",children:["3. ",(0,r.jsx)(n.strong,{children:"Element Local Coordinates"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Origin: Element's own coordinate system"}),"\n",(0,r.jsx)(n.li,{children:"Units: Relative to element's transform matrix"}),"\n",(0,r.jsx)(n.li,{children:"Used for: Path data, shape dimensions, nested transforms"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Coordinate conversion"})," (from ",(0,r.jsx)(n.code,{children:"useViewportController"}),"):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Screen to canvas coordinates (via SVG coordinate transformation)\nfunction screenToCanvas(svg: SVGSVGElement, screenX: number, screenY: number): Point {\n  const point = svg.createSVGPoint();\n  point.x = screenX;\n  point.y = screenY;\n  const ctm = svg.getScreenCTM();\n  if (ctm) {\n    const transformed = point.matrixTransform(ctm.inverse());\n    return { x: transformed.x, y: transformed.y };\n  }\n  return { x: screenX, y: screenY };\n}\n\n// Canvas to screen coordinates\nfunction canvasToScreen(x: number, y: number, viewport: Viewport): Point {\n  return {\n    x: x * viewport.zoom + viewport.offsetX,\n    y: y * viewport.zoom + viewport.offsetY\n  };\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"rendering-pipeline",children:"Rendering Pipeline"}),"\n",(0,r.jsxs)(n.p,{children:["The canvas uses ",(0,r.jsx)(n.strong,{children:"React's reconciliation"})," with SVG elements for rendering:"]}),"\n",(0,r.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant Store as Canvas Store\n    participant Canvas as Canvas Component\n    participant Registry as Renderer Registry\n    participant React as React/SVG DOM\n    \n    Store->>Canvas: State change (elements updated)\n    Canvas->>Canvas: Re-render triggered\n    Canvas->>Canvas: Compute render context\n    Canvas->>Registry: renderElement(element, context)\n    Registry->>Registry: Select renderer (PathElement, etc.)\n    Registry->>React: Return React SVG components\n    React->>React: Reconcile Virtual DOM\n    React->>React: Update real DOM (SVG)\n    React->>Canvas: Display updated SVG"}),"\n",(0,r.jsx)(n.h3,{id:"rendering-phases",children:"Rendering Phases"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"State Change"}),": Canvas Store state update triggers Canvas re-render"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Context Preparation"}),": Build ",(0,r.jsx)(n.code,{children:"CanvasRenderContext"})," with viewport, handlers, selections"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Element Rendering"}),": Each element passed through ",(0,r.jsx)(n.code,{children:"canvasRendererRegistry.render()"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Component Creation"}),": Registry returns React SVG components (",(0,r.jsx)(n.code,{children:"<path>"}),", ",(0,r.jsx)(n.code,{children:"<g>"}),", etc.)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"React Reconciliation"}),": React diffs and updates actual SVG DOM"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Plugin Layers"}),": Plugins render their overlays on top via ",(0,r.jsx)(n.code,{children:"CanvasLayers"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"renderer-registry",children:"Renderer Registry"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"CanvasRendererRegistry"})," (",(0,r.jsx)(n.code,{children:"/src/canvas/renderers/CanvasRendererRegistry.ts"}),") maps element types to React components:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface CanvasRenderContext {\n  viewport: Viewport;\n  activePlugin: string;\n  isElementHidden: (id: string) => boolean;\n  isElementLocked: (id: string) => boolean;\n  isElementSelected: (id: string) => boolean;\n  isTransforming: boolean;\n  isSelecting: boolean;\n  isCreatingShape: boolean;\n  eventHandlers: {\n    onPointerUp: (id: string, e: React.PointerEvent) => void;\n    onPointerDown: (id: string, e: React.PointerEvent) => void;\n    onDoubleClick: (id: string, e: React.MouseEvent) => void;\n    onTouchEnd: (id: string, e: React.TouchEvent) => void;\n  };\n}\n\ncanvasRendererRegistry.render(element, context) // Returns React.ReactNode\n"})}),"\n",(0,r.jsx)(n.h2,{id:"event-handling",children:"Event Handling"}),"\n",(0,r.jsxs)(n.p,{children:["The Canvas uses an ",(0,r.jsx)(n.strong,{children:"Event Bus architecture"})," for plugin communication:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Event flow\nPointer/Touch/Keyboard event on SVG\n  \u2193\nCanvas event handler (useCanvasEventHandlers)\n  \u2193\nConvert screen coords to canvas coords (screenToCanvas)\n  \u2193\nEmit to Event Bus (eventBus.emit)\n  \u2193\nPlugins subscribed to event receive notification\n  \u2193\nPlugin updates Canvas Store state\n  \u2193\nCanvas re-renders with new state\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Core Event Handlers"})," (from ",(0,r.jsx)(n.code,{children:"useCanvasEventHandlers"}),"):"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"handlePointerDown"}),": Start interactions (selection, dragging, drawing)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"handlePointerMove"}),": Continuous interactions (dragging, drawing strokes)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"handlePointerUp"}),": End interactions (finalize selection, complete paths)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"handleElementClick"}),": Element selection/deselection"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"handleElementDoubleClick"}),": Enter edit mode for elements"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"handleCanvasDoubleClick"}),": Exit current mode to select mode"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Event Bus Events"})," (",(0,r.jsx)(n.code,{children:"CanvasEventBusContext"}),"):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"eventBus.emit('pointerdown', { event, point, target, activePlugin, helpers, state });\neventBus.emit('pointermove', { event, point, target, activePlugin, helpers, state });\neventBus.emit('pointerup', { event, point, target, activePlugin, helpers, state });\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Plugins subscribe to these events via ",(0,r.jsx)(n.code,{children:"useCanvasEventBus()"})," hook."]}),"\n",(0,r.jsx)(n.h2,{id:"viewport-management",children:"Viewport Management"}),"\n",(0,r.jsxs)(n.p,{children:["The viewport controls the ",(0,r.jsx)(n.strong,{children:"visible region"})," and ",(0,r.jsx)(n.strong,{children:"zoom level"})," using ",(0,r.jsx)(n.strong,{children:"SVG viewBox"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface Viewport {\n  offsetX: number;      // Pan X offset (canvas units)\n  offsetY: number;      // Pan Y offset (canvas units)\n  zoom: number;         // Zoom level (0.1 to 10.0)\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"ViewBox Calculation"})," (from ",(0,r.jsx)(n.code,{children:"useViewportController"}),"):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"function getViewBoxString(canvasSize: Size): string {\n  const viewportWidth = canvasSize.width / viewport.zoom;\n  const viewportHeight = canvasSize.height / viewport.zoom;\n  return `${-viewport.offsetX} ${-viewport.offsetY} ${viewportWidth} ${viewportHeight}`;\n}\n\n// Applied to SVG element:\n<svg viewBox={getViewBoxString(canvasSize)} ... />\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Viewport Operations:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Pan"}),": Translate canvas view (Space + Drag, implemented in ",(0,r.jsx)(n.code,{children:"useCanvasDragInteractions"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Zoom"}),": Scale canvas view (Ctrl/Cmd + Wheel in ",(0,r.jsx)(n.code,{children:"useCanvasZoom"}),", or Pinch in ",(0,r.jsx)(n.code,{children:"useMobileTouchGestures"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Reset Zoom"}),": ",(0,r.jsx)(n.code,{children:"resetZoom()"})," action in Canvas Store (resets to zoom: 1, offsets: 0)"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Zoom Behavior"})," (from ",(0,r.jsx)(n.code,{children:"useCanvasZoom"}),"):"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Zoom centers on ",(0,r.jsx)(n.strong,{children:"mouse cursor position"})," (not canvas center)"]}),"\n",(0,r.jsxs)(n.li,{children:["Minimum zoom: ",(0,r.jsx)(n.code,{children:"0.1"})," (10%)"]}),"\n",(0,r.jsxs)(n.li,{children:["Maximum zoom: ",(0,r.jsx)(n.code,{children:"10.0"})," (1000%)"]}),"\n",(0,r.jsxs)(n.li,{children:["Zoom steps: ",(0,r.jsx)(n.code,{children:"zoomFactor = 1.2"})," multiplier per action"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"canvas-state",children:"Canvas State"}),"\n",(0,r.jsxs)(n.p,{children:["The Canvas subscribes to ",(0,r.jsx)(n.strong,{children:"Canvas Store"})," state using Zustand selectors:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// From Canvas.tsx and custom hooks\nconst elements = useCanvasStore(state => state.elements);\nconst viewport = useCanvasStore(state => state.viewport);\nconst selectedIds = useCanvasStore(state => state.selectedIds);\nconst editingPoint = useCanvasStore(state => state.editingPoint);\nconst selectedCommands = useCanvasStore(state => state.selectedCommands);\nconst selectedSubpaths = useCanvasStore(state => state.selectedSubpaths);\nconst draggingSelection = useCanvasStore(state => state.draggingSelection);\nconst pencil = useCanvasStore(state => state.pencil);\nconst addPointMode = useCanvasStore(state => state.addPointMode);\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Key State Properties:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"elements"}),": Array of all canvas elements (paths, groups, shapes, text)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"viewport"}),": Pan/zoom state (offsetX, offsetY, zoom)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"selectedIds"}),": Currently selected element IDs"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"elementMap"}),": Map of element ID \u2192 element (for fast lookups)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"sortedElements"}),": Elements sorted by Z-index (rendering order)"]}),"\n",(0,r.jsxs)(n.li,{children:["Plugin-specific state: ",(0,r.jsx)(n.code,{children:"pencil"}),", ",(0,r.jsx)(n.code,{children:"addPointMode"}),", ",(0,r.jsx)(n.code,{children:"editingPoint"}),", etc."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"performance-optimizations",children:"Performance Optimizations"}),"\n",(0,r.jsx)(n.p,{children:"TTPE implements several optimizations for smooth rendering:"}),"\n",(0,r.jsxs)(n.h3,{id:"1-react-svg-reconciliation",children:["1. ",(0,r.jsx)(n.strong,{children:"React SVG Reconciliation"})]}),"\n",(0,r.jsx)(n.p,{children:"React efficiently diffs and updates only changed SVG elements (not full re-renders)."}),"\n",(0,r.jsxs)(n.h3,{id:"2-zustand-granular-selectors",children:["2. ",(0,r.jsx)(n.strong,{children:"Zustand Granular Selectors"})]}),"\n",(0,r.jsx)(n.p,{children:"Use specific selectors to minimize component re-renders:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// \u274c Bad: Re-renders on ANY state change\nconst state = useCanvasStore();\n\n// \u2705 Good: Only re-renders when elements change\nconst elements = useCanvasStore(state => state.elements);\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"3-memoized-contexts",children:["3. ",(0,r.jsx)(n.strong,{children:"Memoized Contexts"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"canvasLayerContext"})," and ",(0,r.jsx)(n.code,{children:"renderContext"})," use ",(0,r.jsx)(n.code,{children:"useMemo"})," to prevent unnecessary re-creation."]}),"\n",(0,r.jsxs)(n.h3,{id:"4-ref-based-callbacks",children:["4. ",(0,r.jsx)(n.strong,{children:"Ref-Based Callbacks"})]}),"\n",(0,r.jsxs)(n.p,{children:["Functions like ",(0,r.jsx)(n.code,{children:"moveSelectedElements"})," stored in refs to avoid stale closures:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const moveSelectedElementsRef = useRef(moveSelectedElements);\nuseEffect(() => {\n  moveSelectedElementsRef.current = moveSelectedElements;\n}, [moveSelectedElements]);\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"5-dynamic-canvas-size",children:["5. ",(0,r.jsx)(n.strong,{children:"Dynamic Canvas Size"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"useDynamicCanvasSize"})," hook adjusts canvas dimensions to viewport without full re-renders."]}),"\n",(0,r.jsxs)(n.h3,{id:"6-temporal-state-subscription",children:["6. ",(0,r.jsx)(n.strong,{children:"Temporal State Subscription"})]}),"\n",(0,r.jsx)(n.p,{children:"Undo/redo state subscribed separately to avoid main Canvas re-renders on history changes."}),"\n",(0,r.jsx)(n.h2,{id:"canvas-overlays-plugin-layers",children:"Canvas Overlays (Plugin Layers)"}),"\n",(0,r.jsxs)(n.p,{children:["Overlays are rendered by ",(0,r.jsxs)(n.strong,{children:["plugins through ",(0,r.jsx)(n.code,{children:"CanvasLayers"})," component"]}),":"]}),"\n",(0,r.jsx)(n.h3,{id:"plugin-layer-system",children:"Plugin Layer System"}),"\n",(0,r.jsx)(n.p,{children:"Plugins register layers via Plugin Manager that render on top of canvas elements:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Example: SelectionOverlay from Select Plugin\npluginManager.registerPlugin({\n  id: 'select',\n  layers: [\n    {\n      id: 'selection-overlay',\n      component: SelectionOverlay,\n      position: 'overlay', // Renders on top of elements\n    }\n  ]\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"common-plugin-overlays",children:"Common Plugin Overlays"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Select Plugin"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Selection rectangles (blue dashed borders)"}),"\n",(0,r.jsx)(n.li,{children:"Transformation handles (corner/edge handles)"}),"\n",(0,r.jsx)(n.li,{children:"Rotation handle"}),"\n",(0,r.jsx)(n.li,{children:"Center point indicator"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Edit Plugin"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"B\xe9zier control point handles"}),"\n",(0,r.jsx)(n.li,{children:"Control point connecting lines"}),"\n",(0,r.jsx)(n.li,{children:"Smooth brush cursor"}),"\n",(0,r.jsx)(n.li,{children:"Add point mode indicators"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Subpath Plugin"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Path direction indicators"}),"\n",(0,r.jsx)(n.li,{children:"Start/end markers"}),"\n",(0,r.jsx)(n.li,{children:"Selected subpath highlighting"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Grid Plugin"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Grid lines (configurable spacing, subdivisions)"}),"\n",(0,r.jsx)(n.li,{children:"Ruler markings"}),"\n",(0,r.jsx)(n.li,{children:"Origin indicator"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Guidelines Plugin"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Horizontal/vertical alignment guides"}),"\n",(0,r.jsx)(n.li,{children:"Snapping indicators (red lines)"}),"\n",(0,r.jsx)(n.li,{children:"Distance labels"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"integration-with-plugins",children:"Integration with Plugins"}),"\n",(0,r.jsx)(n.p,{children:"The Canvas exposes multiple integration points for plugins:"}),"\n",(0,r.jsxs)(n.h3,{id:"1-event-bus-subscriptions",children:["1. ",(0,r.jsx)(n.strong,{children:"Event Bus Subscriptions"})]}),"\n",(0,r.jsx)(n.p,{children:"Plugins subscribe to pointer/touch events:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const eventBus = useCanvasEventBus();\n\nuseEffect(() => {\n  const handlePointerDown = (eventData) => {\n    // Plugin logic here\n  };\n  \n  eventBus.on('pointerdown', handlePointerDown);\n  return () => eventBus.off('pointerdown', handlePointerDown);\n}, [eventBus]);\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"2-canvas-layer-context",children:["2. ",(0,r.jsx)(n.strong,{children:"Canvas Layer Context"})]}),"\n",(0,r.jsxs)(n.p,{children:["Plugins receive ",(0,r.jsx)(n.code,{children:"CanvasLayerContext"})," with controller methods:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface CanvasLayerContext {\n  // Controller methods\n  elements: CanvasElement[];\n  viewport: Viewport;\n  selectedIds: string[];\n  updateElement: (id: string, updates: Partial<CanvasElement>) => void;\n  // ... many more methods\n  \n  // Canvas-specific\n  activePlugin: string;\n  canvasSize: Size;\n  getElementBounds: (elementId: string) => Bounds | null;\n  \n  // Plugin-specific (conditionally added)\n  isSmoothBrushActive?: boolean;\n  smoothBrush?: SmoothBrushState;\n  isCreatingShape?: boolean;\n  shapeStart?: Point;\n  // ...\n}\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"3-canvas-store-access",children:["3. ",(0,r.jsx)(n.strong,{children:"Canvas Store Access"})]}),"\n",(0,r.jsx)(n.p,{children:"Plugins directly access Canvas Store for state and actions:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const elements = useCanvasStore(state => state.elements);\nconst addElement = useCanvasStore(state => state.addElement);\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"4-renderer-registry",children:["4. ",(0,r.jsx)(n.strong,{children:"Renderer Registry"})]}),"\n",(0,r.jsx)(n.p,{children:"Plugins can register custom element renderers:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"canvasRendererRegistry.register('custom-type', CustomElementRenderer);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"canvas-component-props",children:"Canvas Component Props"}),"\n",(0,r.jsxs)(n.p,{children:["The Canvas component is ",(0,r.jsx)(n.strong,{children:"self-contained"})," with no props:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export const Canvas: React.FC = () => {\n  // All state from Canvas Store\n  // All interactions via Event Bus\n  // All rendering via React SVG\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"The Canvas is fully reactive to Canvas Store state changes."}),"\n",(0,r.jsx)(n.h2,{id:"file-structure",children:"File Structure"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"src/canvas/\n\u251c\u2500\u2500 Canvas.tsx                          # Main Canvas component (522 lines)\n\u251c\u2500\u2500 CanvasEventBusContext.tsx           # Event Bus Context and Provider\n\u251c\u2500\u2500 components/\n\u2502   \u251c\u2500\u2500 CanvasLayers.tsx                # Plugin layer rendering\n\u2502   \u2514\u2500\u2500 CanvasStage.tsx                 # Main SVG stage component\n\u251c\u2500\u2500 controller/\n\u2502   \u251c\u2500\u2500 CanvasControllerContext.ts      # Controller Context definition\n\u2502   \u2514\u2500\u2500 CanvasControllerProvider.tsx    # Centralized controller with all canvas operations\n\u251c\u2500\u2500 geometry/\n\u2502   \u2514\u2500\u2500 CanvasGeometryService.ts        # Geometric calculations service\n\u251c\u2500\u2500 hooks/                              # 24 specialized hooks\n\u2502   \u251c\u2500\u2500 useCanvasDragInteractions.ts    # Drag point/element interactions\n\u2502   \u251c\u2500\u2500 useCanvasEventBusManager.ts     # Event bus instance management\n\u2502   \u251c\u2500\u2500 useCanvasEventHandlerDeps.ts    # Event handler dependencies preparation\n\u2502   \u251c\u2500\u2500 useCanvasEventHandlers.ts       # Main event handlers (pointer/touch/click)\n\u2502   \u251c\u2500\u2500 useCanvasGeometry.ts            # Element bounds calculations\n\u2502   \u251c\u2500\u2500 useCanvasKeyboardControls.ts    # Keyboard state (Space, modifiers)\n\u2502   \u251c\u2500\u2500 useCanvasModeMachine.ts         # Mode state machine\n\u2502   \u251c\u2500\u2500 useCanvasPointerSelection.ts    # Pointer-based selection\n\u2502   \u251c\u2500\u2500 useCanvasServiceActivation.ts   # Service activation logic\n\u2502   \u251c\u2500\u2500 useCanvasShapeCreation.ts       # Shape creation interactions\n\u2502   \u251c\u2500\u2500 useCanvasShortcuts.ts           # Keyboard shortcut registry\n\u2502   \u251c\u2500\u2500 useCanvasSideEffects.ts         # Side effects management\n\u2502   \u251c\u2500\u2500 useCanvasSmoothBrush.ts         # Smooth brush for transformations\n\u2502   \u251c\u2500\u2500 useCanvasTransformControls.ts   # Transformation (move/rotate/scale)\n\u2502   \u251c\u2500\u2500 useCanvasZoom.ts                # Mouse wheel zoom\n\u2502   \u251c\u2500\u2500 useDoubleTap.ts                 # Touch double-tap detection\n\u2502   \u251c\u2500\u2500 useDynamicCanvasSize.ts         # Responsive canvas sizing\n\u2502   \u251c\u2500\u2500 useEditAddPoint.ts              # Edit mode: add point to path\n\u2502   \u251c\u2500\u2500 useEditSmoothBrush.ts           # Edit mode: smooth brush\n\u2502   \u251c\u2500\u2500 useElementDoubleTap.ts          # Element double-tap handler\n\u2502   \u251c\u2500\u2500 useMobileTouchGestures.ts       # Touch gestures (pinch zoom, pan)\n\u2502   \u251c\u2500\u2500 usePencilDrawing.ts             # Pencil drawing service management\n\u2502   \u251c\u2500\u2500 usePointerStateController.ts    # Pointer state coordination\n\u2502   \u251c\u2500\u2500 useSelectionController.ts       # Selection rectangle logic\n\u2502   \u2514\u2500\u2500 useViewportController.ts        # Viewport transformation (viewBox)\n\u251c\u2500\u2500 interactions/                       # Interaction controllers\n\u2502   \u251c\u2500\u2500 CurvesController.ts             # Curves plugin interactions\n\u2502   \u251c\u2500\u2500 SelectionController.ts          # Selection logic\n\u2502   \u251c\u2500\u2500 ShapeCreationController.ts      # Shape creation logic\n\u2502   \u251c\u2500\u2500 SmoothBrushController.ts        # Smooth brush logic\n\u2502   \u2514\u2500\u2500 TransformController.ts          # Transformation logic\n\u251c\u2500\u2500 listeners/\n\u2502   \u2514\u2500\u2500 AddPointListener.ts             # Add point event listener\n\u251c\u2500\u2500 modes/\n\u2502   \u2514\u2500\u2500 CanvasModeMachine.ts            # Mode state machine definition\n\u251c\u2500\u2500 renderers/\n\u2502   \u251c\u2500\u2500 CanvasRendererRegistry.ts       # Element renderer registry\n\u2502   \u251c\u2500\u2500 PathElementRenderer.tsx         # Path element SVG renderer\n\u2502   \u2514\u2500\u2500 index.ts                        # Exports\n\u251c\u2500\u2500 selection/\n\u2502   \u2514\u2500\u2500 SelectionController.ts          # Selection state management\n\u251c\u2500\u2500 services/\n\u2502   \u251c\u2500\u2500 CanvasServicesProvider.tsx      # Services Context Provider\n\u2502   \u2514\u2500\u2500 PencilDrawingService.ts         # Pencil drawing service\n\u251c\u2500\u2500 shortcuts/                          # Keyboard shortcut definitions\n\u2514\u2500\u2500 viewport/\n    \u2514\u2500\u2500 ViewportController.ts           # Viewport operations\n"})}),"\n",(0,r.jsx)(n.h2,{id:"usage-example",children:"Usage Example"}),"\n",(0,r.jsx)(n.p,{children:"The Canvas is rendered in the main App component:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"import { Canvas } from './canvas/Canvas';\n\nfunction App() {\n  return (\n    <div style={{ width: '100vw', height: '100vh', position: 'relative' }}>\n      <Canvas />\n      <Sidebar />\n      <TopActionBar />\n      <BottomActionBar />\n    </div>\n  );\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"Canvas is positioned absolutely to fill viewport, with UI overlays on top."}),"\n",(0,r.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/ttpe/docs/architecture/overview",children:"Architecture Overview"})," - Application architecture"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/ttpe/docs/plugins/overview",children:"Plugin System"})," - How plugins interact with Canvas"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/ttpe/docs/plugins/catalog/select",children:"Select Plugin"})," - Selection and transformation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/ttpe/docs/plugins/catalog/pencil",children:"Pencil Plugin"})," - Freehand drawing on canvas"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/ttpe/docs/features/transforms",children:"Transform System"})," - Element transformations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/ttpe/docs/features/transforms",children:"Viewport Operations"})," - Pan and zoom"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsx)(n.h3,{id:"for-plugin-developers",children:"For Plugin Developers"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use Event Bus"}),": Subscribe to ",(0,r.jsx)(n.code,{children:"pointerdown"}),"/",(0,r.jsx)(n.code,{children:"pointermove"}),"/",(0,r.jsx)(n.code,{children:"pointerup"})," via ",(0,r.jsx)(n.code,{children:"useCanvasEventBus()"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Access Layer Context"}),": Receive ",(0,r.jsx)(n.code,{children:"CanvasLayerContext"})," in plugin layer components"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Convert coordinates"}),": Use ",(0,r.jsx)(n.code,{children:"screenToCanvas"})," from context for pointer coordinates"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Render overlays"}),": Register plugin layers to render on top of elements"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Clean up subscriptions"}),": Unsubscribe from Event Bus in cleanup functions"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"for-contributors",children:"For Contributors"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Create focused hooks"}),": Keep hooks single-purpose and composable"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use refs for callbacks"}),": Avoid stale closures with ",(0,r.jsx)(n.code,{children:"useRef"})," + ",(0,r.jsx)(n.code,{children:"useEffect"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Memoize expensive values"}),": Use ",(0,r.jsx)(n.code,{children:"useMemo"})," for computed contexts"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Granular Zustand selectors"}),": Subscribe to specific state slices only"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Test across devices"}),": Verify pointer/touch events work on desktop, tablet, mobile"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Profile rendering"}),": Use React DevTools Profiler to identify re-render bottlenecks"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>a});var t=s(6540);const r={},i=t.createContext(r);function o(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);