"use strict";(self.webpackChunkttpe_docs=self.webpackChunkttpe_docs||[]).push([[1798],{2755:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"features/persistence","title":"Persistence","description":"The persistence system provides automatic state storage to localStorage, ensuring user work is preserved across browser sessions. Built on Zustand\'s persist middleware, the system serializes canvas state to the browser\'s local storage, rehydrates it on application load, and handles storage quota limits gracefully.","source":"@site/docs/features/persistence.md","sourceDirName":"features","slug":"/features/persistence","permalink":"/ttpe/docs/docs/features/persistence","draft":false,"unlisted":false,"editUrl":"https://github.com/ekrsulov/ttpe/tree/main/doc/docs/features/persistence.md","tags":[],"version":"current","lastUpdatedBy":"Ernesto Krsulovic","lastUpdatedAt":1762144584000,"frontMatter":{"id":"persistence","title":"Persistence","sidebar_label":"Persistence"},"sidebar":"docs","previous":{"title":"Undo/Redo","permalink":"/ttpe/docs/docs/features/undo-redo"},"next":{"title":"Mobile","permalink":"/ttpe/docs/docs/features/mobile"}}');var r=s(4848),i=s(8453);const a={id:"persistence",title:"Persistence",sidebar_label:"Persistence"},o="Persistence",l={},d=[{value:"Overview",id:"overview",level:2},{value:"Persistence Flow",id:"persistence-flow",level:2},{value:"What&#39;s Saved",id:"whats-saved",level:2},{value:"Canvas Elements",id:"canvas-elements",level:3},{value:"User Settings",id:"user-settings",level:3},{value:"Plugin State",id:"plugin-state",level:3},{value:"What&#39;s Not Saved",id:"whats-not-saved",level:2},{value:"Undo/Redo History",id:"undoredo-history",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Configuration Parameters",id:"configuration-parameters",level:3},{value:"Partialize Example",id:"partialize-example",level:3},{value:"Storage Key Structure",id:"storage-key-structure",level:2},{value:"Manual Control",id:"manual-control",level:2},{value:"Manual Save",id:"manual-save",level:3},{value:"Manual Restore",id:"manual-restore",level:3},{value:"Clear Persisted State",id:"clear-persisted-state",level:3},{value:"Storage Limits",id:"storage-limits",level:2},{value:"Browser Quota",id:"browser-quota",level:3},{value:"Handling Quota Exceeded",id:"handling-quota-exceeded",level:3},{value:"Reducing Storage Size",id:"reducing-storage-size",level:3},{value:"Migration Strategy",id:"migration-strategy",level:2},{value:"Version Detection",id:"version-detection",level:3},{value:"Migration Functions",id:"migration-functions",level:3},{value:"Apply Migrations on Load",id:"apply-migrations-on-load",level:3},{value:"Fallback on Migration Failure",id:"fallback-on-migration-failure",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"For Users",id:"for-users",level:3},{value:"For Plugin Developers",id:"for-plugin-developers",level:3},{value:"Common Use Cases",id:"common-use-cases",level:2},{value:"Backup Before Risky Operation",id:"backup-before-risky-operation",level:3},{value:"Restore from Specific Backup",id:"restore-from-specific-backup",level:3},{value:"Export/Import Document",id:"exportimport-document",level:3},{value:"Clear State on Logout",id:"clear-state-on-logout",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"State Not Persisting",id:"state-not-persisting",level:3},{value:"Corrupted State on Load",id:"corrupted-state-on-load",level:3},{value:"Storage Quota Exceeded",id:"storage-quota-exceeded",level:3},{value:"Lost Data After Browser Update",id:"lost-data-after-browser-update",level:3},{value:"Related Documentation",id:"related-documentation",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"persistence",children:"Persistence"})}),"\n",(0,r.jsxs)(n.p,{children:["The persistence system provides ",(0,r.jsx)(n.strong,{children:"automatic state storage"})," to ",(0,r.jsx)(n.code,{children:"localStorage"}),", ensuring user work is preserved across browser sessions. Built on Zustand's persist middleware, the system serializes canvas state to the browser's local storage, rehydrates it on application load, and handles storage quota limits gracefully."]}),"\n",(0,r.jsx)(n.p,{children:"Persistence is essential for a web-based editor, enabling users to close their browser without losing work, recover from crashes, and maintain continuity between editing sessions."}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsxs)(n.p,{children:["Persistence operates through Zustand's ",(0,r.jsx)(n.strong,{children:"persist middleware"}),", which wraps the store and intercepts state changes. When state updates occur, the middleware serializes the configured state slice to JSON and writes it to ",(0,r.jsx)(n.code,{children:"localStorage"})," under the key ",(0,r.jsx)(n.code,{children:"canvas-app-state"}),". On application load, the middleware reads from storage, deserializes the JSON, and merges it into the initial store state."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Key characteristics:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Automatic persistence"}),": Every state change triggers storage update (debounced)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Full state storage"}),": All state is persisted by default (see Configuration section)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"localStorage backend"}),": Uses browser's ",(0,r.jsx)(n.code,{children:"localStorage"})," API (typically 5-10 MB limit)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"JSON serialization"}),": State is serialized to JSON for storage"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Graceful degradation"}),": Falls back to default state if storage is unavailable"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"No undo history"}),": Undo/redo stacks are excluded via temporal middleware's ",(0,r.jsx)(n.code,{children:"partialize"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"persistence-flow",children:"Persistence Flow"}),"\n",(0,r.jsx)(n.mermaid,{value:"flowchart TD\n    Start([State Update]) --\x3e Check{Persistence<br/>enabled?}\n    Check --\x3e|No| End([End])\n    Check --\x3e|Yes| Serialize[Serialize state]\n    \n    Serialize --\x3e Partialize[Apply partialize filter<br/>keep essential fields]\n    Partialize --\x3e JSON[JSON.stringify<br/>convert to string]\n    JSON --\x3e LocalStorage[Write to localStorage<br/>key: canvas-app-state]\n    \n    LocalStorage --\x3e Success{Success?}\n    Success --\x3e|Yes| End\n    Success --\x3e|No| Error[Log error<br/>QuotaExceededError?]\n    Error --\x3e End\n    \n    Start2([App Load]) --\x3e CheckLS{localStorage<br/>has data?}\n    CheckLS --\x3e|No| Defaults[Use default state<br/>empty canvas]\n    CheckLS --\x3e|Yes| Read[Read from localStorage<br/>key: canvas-app-state]\n    \n    Read --\x3e Parse[JSON.parse<br/>deserialize]\n    Parse --\x3e Validate{Valid structure?}\n    Validate --\x3e|Yes| Migrate{Migration<br/>needed?}\n    Validate --\x3e|No| Defaults\n    \n    Migrate --\x3e|Yes| RunMigration[Run migration functions<br/>v1 \u2192 v2 etc.]\n    Migrate --\x3e|No| Restore[Restore to store]\n    RunMigration --\x3e Restore\n    Defaults --\x3e Restore\n    Restore --\x3e End2([App Ready])\n    \n    Error2[Parse error] -.-> Defaults\n    Parse -.->|JSON.parse fails| Error2\n    \n    style Error fill:#f44336\n    style Error2 fill:#f44336\n    style Defaults fill:#ff9800\n    style Restore fill:#4caf50"}),"\n",(0,r.jsx)(n.h2,{id:"whats-saved",children:"What's Saved"}),"\n",(0,r.jsxs)(n.p,{children:["The following state is ",(0,r.jsx)(n.strong,{children:"automatically persisted"})," to ",(0,r.jsx)(n.code,{children:"localStorage"}),":"]}),"\n",(0,r.jsx)(n.h3,{id:"canvas-elements",children:"Canvas Elements"}),"\n",(0,r.jsx)(n.p,{children:"All canvas elements (paths, groups, shapes) and their complete data:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Element IDs"}),": Unique identifiers for each element"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Type"}),": Element type (",(0,r.jsx)(n.code,{children:"path"}),", ",(0,r.jsx)(n.code,{children:"group"}),", etc.)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Position"}),": ",(0,r.jsx)(n.code,{children:"x"}),", ",(0,r.jsx)(n.code,{children:"y"})," coordinates"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Dimensions"}),": ",(0,r.jsx)(n.code,{children:"width"}),", ",(0,r.jsx)(n.code,{children:"height"}),", ",(0,r.jsx)(n.code,{children:"rotation"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Hierarchy"}),": ",(0,r.jsx)(n.code,{children:"parentId"})," (for grouped elements), ",(0,r.jsx)(n.code,{children:"zIndex"})," (layer order)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Visibility"}),": ",(0,r.jsx)(n.code,{children:"visible"}),", ",(0,r.jsx)(n.code,{children:"locked"})," flags"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Path data"}),": Complete path commands, subpaths, stroke/fill styles"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Group data"}),": Group transforms, children references"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Storage key:"})," ",(0,r.jsx)(n.code,{children:"elements"})," array in persisted state"]}),"\n",(0,r.jsx)(n.h3,{id:"user-settings",children:"User Settings"}),"\n",(0,r.jsx)(n.p,{children:"Global application settings and preferences:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Keyboard precision"}),": ",(0,r.jsx)(n.code,{children:"keyboardMovementPrecision"})," (decimal places for arrow key movement)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Render badges"}),": ",(0,r.jsx)(n.code,{children:"showRenderCountBadges"})," (debug mode for render counts)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Minimap"}),": ",(0,r.jsx)(n.code,{children:"showMinimap"})," (minimap overlay visibility)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Tooltips"}),": ",(0,r.jsx)(n.code,{children:"showTooltips"})," (tooltip visibility on desktop)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Default stroke color"}),": ",(0,r.jsx)(n.code,{children:"defaultStrokeColor"})," (default stroke color for new paths)"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Note:"})," Grid settings (",(0,r.jsx)(n.code,{children:"showGrid"}),", ",(0,r.jsx)(n.code,{children:"gridSize"}),", ",(0,r.jsx)(n.code,{children:"snapToGrid"}),") are managed by the Grid plugin, not in the base settings object."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Storage key:"})," ",(0,r.jsx)(n.code,{children:"settings"})," object in persisted state"]}),"\n",(0,r.jsx)(n.h3,{id:"plugin-state",children:"Plugin State"}),"\n",(0,r.jsx)(n.p,{children:"Plugin-specific state that contributes to canvas appearance:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Guidelines plugin"}),": Guide positions, visibility"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Grid plugin"}),": Grid type (cartesian, hexagonal), spacing"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Minimap plugin"}),": Minimap visibility (if persisted by plugin)"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Note:"})," Plugin persistence is opt-in; plugins define what to persist via their slice configuration."]}),"\n",(0,r.jsx)(n.h2,{id:"whats-not-saved",children:"What's Not Saved"}),"\n",(0,r.jsxs)(n.p,{children:["The following state is managed by temporal middleware's ",(0,r.jsx)(n.code,{children:"partialize"})," function and ",(0,r.jsx)(n.strong,{children:"excluded from undo/redo history"})," (but still persisted to localStorage):"]}),"\n",(0,r.jsx)(n.h3,{id:"undoredo-history",children:"Undo/Redo History"}),"\n",(0,r.jsx)(n.p,{children:"Temporal middleware history stacks are not persisted to localStorage:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Past states"}),": ",(0,r.jsx)(n.code,{children:"temporal.pastStates[]"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Future states"}),": ",(0,r.jsx)(n.code,{children:"temporal.futureStates[]"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Rationale:"})," Undo history can be large (50 snapshots \xd7 full state size) and is session-specific. Users expect undo to work within a session but not across reloads."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Note:"})," The temporal middleware uses its own ",(0,r.jsx)(n.code,{children:"partialize"})," function that only includes ",(0,r.jsx)(n.code,{children:"elements"}),", ",(0,r.jsx)(n.code,{children:"selectedIds"}),", and ",(0,r.jsx)(n.code,{children:"viewport"})," in the undo/redo history. However, the persist middleware saves the full state (including viewport, UI panels, settings, and all plugin state) to localStorage."]}),"\n",(0,r.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["Persistence is configured in ",(0,r.jsx)(n.code,{children:"src/store/canvasStore.ts"})," using Zustand's ",(0,r.jsx)(n.code,{children:"persist"})," middleware:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const useCanvasStore = create<CanvasStore>()(\n  persist(\n    temporal(\n      (...args) => ({\n        ...createBaseSlice(...args),\n        ...createViewportSlice(...args),\n        // ... other slices\n      }),\n      { /* temporal config */ }\n    ),\n    {\n      // Storage key in localStorage\n      name: 'canvas-app-state',\n      \n      // Partialize: filter what to persist\n      partialize: (state: CanvasStore) => {\n        const { ...rest } = state;\n        return rest; // Currently persists all state (adjust as needed)\n      }\n    }\n  )\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"configuration-parameters",children:"Configuration Parameters"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Parameter"}),(0,r.jsx)(n.th,{children:"Value"}),(0,r.jsx)(n.th,{children:"Purpose"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"name"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"'canvas-app-state'"})}),(0,r.jsx)(n.td,{children:"Key used in localStorage"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"partialize"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"(state) => state"})}),(0,r.jsx)(n.td,{children:"Function to filter persisted state (currently returns full state)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"storage"})}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"localStorage"})," (default)"]}),(0,r.jsxs)(n.td,{children:["Storage backend (can be ",(0,r.jsx)(n.code,{children:"sessionStorage"})," or custom)"]})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Current Implementation:"})," The ",(0,r.jsx)(n.code,{children:"partialize"})," function currently returns the complete state (",(0,r.jsx)(n.code,{children:"{ ...rest } = state; return rest;"}),"), which means ",(0,r.jsx)(n.strong,{children:"all state is persisted"})," including viewport, UI panels, plugin state, and settings."]}),"\n",(0,r.jsx)(n.h3,{id:"partialize-example",children:"Partialize Example"}),"\n",(0,r.jsx)(n.p,{children:"To exclude specific state explicitly (not currently implemented):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"partialize: (state: CanvasStore) => ({\n  elements: state.elements,\n  selectedIds: state.selectedIds,\n  settings: state.settings,\n  // Explicitly include what you want to persist\n  // Currently all state is persisted\n})\n"})}),"\n",(0,r.jsx)(n.h2,{id:"storage-key-structure",children:"Storage Key Structure"}),"\n",(0,r.jsxs)(n.p,{children:["Data is stored in ",(0,r.jsx)(n.code,{children:"localStorage"})," under the key ",(0,r.jsx)(n.code,{children:"canvas-app-state"})," with the following JSON structure:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "state": {\n    "elements": [\n      {\n        "id": "element-1",\n        "type": "path",\n        "data": { /* path data */ },\n        "zIndex": 0,\n        "parentId": null\n      },\n      // ... more elements\n    ],\n    "selectedIds": ["element-1"],\n    "viewport": {\n      "zoom": 1,\n      "panX": 0,\n      "panY": 0\n    },\n    "settings": {\n      "keyboardMovementPrecision": 2,\n      "showRenderCountBadges": false,\n      "showMinimap": true,\n      "showTooltips": true,\n      "defaultStrokeColor": "#000000"\n    },\n      "keyboardMovePrecision": 1,\n      "showRenderCounters": false,\n      "documentName": "Untitled"\n    },\n    // ... other persisted slices\n  },\n  "version": 0 // Zustand persist version (for migrations)\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"manual-control",children:"Manual Control"}),"\n",(0,r.jsx)(n.p,{children:"While persistence is automatic, you can manually save/restore state for backup or migration purposes:"}),"\n",(0,r.jsx)(n.h3,{id:"manual-save",children:"Manual Save"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Export current state to JSON string\nconst state = useCanvasStore.getState();\nconst stateJSON = JSON.stringify(state, null, 2);\n\n// Save to custom localStorage key (backup)\nlocalStorage.setItem('ttpe-backup', stateJSON);\n\n// Or download as file\nconst blob = new Blob([stateJSON], { type: 'application/json' });\nconst url = URL.createObjectURL(blob);\nconst link = document.createElement('a');\nlink.href = url;\nlink.download = 'canvas-backup.json';\nlink.click();\nURL.revokeObjectURL(url);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"manual-restore",children:"Manual Restore"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Restore from custom localStorage key\nconst backup = localStorage.getItem('ttpe-backup');\nif (backup) {\n  try {\n    const restoredState = JSON.parse(backup);\n    useCanvasStore.setState(restoredState);\n    \n    // Clear undo history after restore\n    useCanvasStore.temporal.getState().clear();\n  } catch (error) {\n    console.error('Failed to restore backup:', error);\n    alert('Invalid backup data');\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"clear-persisted-state",children:"Clear Persisted State"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Remove persisted state from localStorage\nlocalStorage.removeItem('canvas-app-state');\n\n// Then reload page to start fresh\nwindow.location.reload();\n"})}),"\n",(0,r.jsx)(n.h2,{id:"storage-limits",children:"Storage Limits"}),"\n",(0,r.jsx)(n.h3,{id:"browser-quota",children:"Browser Quota"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"localStorage"})," has limited storage capacity:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Typical limit"}),": 5-10 MB per origin"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"QuotaExceededError"}),": Thrown when limit is reached"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"No automatic cleanup"}),": Data persists until manually deleted or quota exceeded"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"handling-quota-exceeded",children:"Handling Quota Exceeded"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"try {\n  localStorage.setItem('canvas-app-state', JSON.stringify(state));\n} catch (error) {\n  if (error instanceof DOMException && error.name === 'QuotaExceededError') {\n    console.error('localStorage quota exceeded');\n    \n    // Option 1: Notify user\n    alert('Storage full. Consider exporting your work.');\n    \n    // Option 2: Clear old data\n    localStorage.removeItem('old-data-key');\n    \n    // Option 3: Switch to export-only mode\n    // (disable auto-persist, require manual save)\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"reducing-storage-size",children:"Reducing Storage Size"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Strategies to minimize storage usage:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Limit element count"}),": Warn users when element count is high"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Compress JSON"}),": Use JSON compression libraries (e.g., lz-string)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Exclude large data"}),": Don't persist preview images or cached data"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Paginate history"}),": Only persist last N elements/operations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use IndexedDB"}),": Switch to IndexedDB for larger storage needs (up to browser limits)"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"migration-strategy",children:"Migration Strategy"}),"\n",(0,r.jsx)(n.p,{children:"When introducing breaking changes to state structure, implement migrations to preserve user data:"}),"\n",(0,r.jsx)(n.h3,{id:"version-detection",children:"Version Detection"}),"\n",(0,r.jsxs)(n.p,{children:["Store a ",(0,r.jsx)(n.code,{children:"version"})," field in persisted state:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface PersistedState {\n  version: number;\n  elements: CanvasElement[];\n  // ... other fields\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"migration-functions",children:"Migration Functions"}),"\n",(0,r.jsx)(n.p,{children:"Create migration functions for each version transition:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"function migrateV1ToV2(oldState: any): PersistedState {\n  return {\n    version: 2,\n    elements: oldState.elements.map((el: any) => ({\n      ...el,\n      // Add new required field with default value\n      locked: el.locked ?? false,\n    })),\n    // ... map other fields\n  };\n}\n\nfunction migrateV2ToV3(oldState: any): PersistedState {\n  // Handle v2 \u2192 v3 changes\n  // ...\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"apply-migrations-on-load",children:"Apply Migrations on Load"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const persistConfig = {\n  name: 'canvas-app-state',\n  version: 3, // Current version\n  migrate: (persistedState: any, version: number): PersistedState => {\n    let state = persistedState;\n    \n    // Apply migrations sequentially\n    if (version < 2) {\n      state = migrateV1ToV2(state);\n    }\n    if (version < 3) {\n      state = migrateV2ToV3(state);\n    }\n    \n    return state;\n  }\n};\n"})}),"\n",(0,r.jsx)(n.h3,{id:"fallback-on-migration-failure",children:"Fallback on Migration Failure"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"migrate: (persistedState: any, version: number): PersistedState | undefined => {\n  try {\n    return applyMigrations(persistedState, version);\n  } catch (error) {\n    console.error('Migration failed:', error);\n    \n    // Option 1: Prompt user to reset\n    if (confirm('State migration failed. Reset to default state?')) {\n      return undefined; // Triggers default state\n    }\n    \n    // Option 2: Return as-is and hope for best\n    return persistedState;\n  }\n};\n"})}),"\n",(0,r.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsx)(n.h3,{id:"for-users",children:"For Users"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Export regularly"}),": Use manual save to download backup files"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Monitor storage"}),": Check browser console for quota warnings"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Clear old sessions"}),": Periodically reset state if working on new projects"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use document name"}),": Set meaningful ",(0,r.jsx)(n.code,{children:"documentName"})," to identify saves"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"for-plugin-developers",children:"For Plugin Developers"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Opt-in persistence"}),": Only persist essential plugin state"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Document persisted fields"}),": Clearly document what your plugin persists"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Handle missing data"}),": Provide defaults if persisted data is absent"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Test migrations"}),": Verify your plugin data migrates correctly across versions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Avoid large data"}),": Don't persist images, cached calculations, or transient data"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"common-use-cases",children:"Common Use Cases"}),"\n",(0,r.jsx)(n.h3,{id:"backup-before-risky-operation",children:"Backup Before Risky Operation"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const backupState = () => {\n  const state = useCanvasStore.getState();\n  const backup = JSON.stringify(state);\n  localStorage.setItem('ttpe-backup-' + Date.now(), backup);\n};\n\n// Before performing risky operation\nbackupState();\nperformRiskyOperation();\n"})}),"\n",(0,r.jsx)(n.h3,{id:"restore-from-specific-backup",children:"Restore from Specific Backup"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const restoreBackup = (timestamp: number) => {\n  const backup = localStorage.getItem(`ttpe-backup-${timestamp}`);\n  if (backup) {\n    const state = JSON.parse(backup);\n    useCanvasStore.setState(state);\n    useCanvasStore.temporal.getState().clear();\n  }\n};\n"})}),"\n",(0,r.jsx)(n.h3,{id:"exportimport-document",children:"Export/Import Document"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Export document to file\nconst exportDocument = () => {\n  const state = useCanvasStore.getState();\n  const documentData = {\n    version: '1.0',\n    elements: state.elements,\n    settings: state.settings,\n    viewport: state.viewport, // Include viewport in export (optional)\n  };\n  \n  const blob = new Blob([JSON.stringify(documentData, null, 2)], {\n    type: 'application/json'\n  });\n  const url = URL.createObjectURL(blob);\n  const link = document.createElement('a');\n  link.href = url;\n  link.download = `${state.documentName}.json`;\n  link.click();\n  URL.revokeObjectURL(url);\n};\n\n// Import document from file\nconst importDocument = async (file: File) => {\n  const text = await file.text();\n  const documentData = JSON.parse(text);\n  \n  // Validate version\n  if (documentData.version !== '1.0') {\n    throw new Error('Unsupported document version');\n  }\n  \n  // Restore state\n  useCanvasStore.setState({\n    elements: documentData.elements,\n    settings: documentData.settings,\n    selectedIds: [], // Clear selection\n  });\n  \n  // Clear undo history\n  useCanvasStore.temporal.getState().clear();\n};\n"})}),"\n",(0,r.jsx)(n.h3,{id:"clear-state-on-logout",children:"Clear State on Logout"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const handleLogout = () => {\n  // Clear persisted state\n  localStorage.removeItem('canvas-app-state');\n  \n  // Reset store to default state\n  useCanvasStore.setState(getDefaultState());\n  \n  // Navigate to login\n  window.location.href = '/login';\n};\n"})}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsx)(n.h3,{id:"state-not-persisting",children:"State Not Persisting"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"})," Changes are not saved to localStorage."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Solutions:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Check browser localStorage is enabled (private/incognito mode may disable it)"}),"\n",(0,r.jsxs)(n.li,{children:["Verify ",(0,r.jsx)(n.code,{children:"persist"})," middleware is correctly configured"]}),"\n",(0,r.jsx)(n.li,{children:"Check console for quota exceeded errors"}),"\n",(0,r.jsxs)(n.li,{children:["Ensure ",(0,r.jsx)(n.code,{children:"partialize"})," includes the fields you expect to persist"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"corrupted-state-on-load",children:"Corrupted State on Load"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"})," App crashes or behaves incorrectly after reload."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Solutions:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Clear localStorage: ",(0,r.jsx)(n.code,{children:"localStorage.removeItem('canvas-app-state')"})]}),"\n",(0,r.jsx)(n.li,{children:"Implement migration functions for version mismatches"}),"\n",(0,r.jsx)(n.li,{children:"Add error boundaries to catch deserialization errors"}),"\n",(0,r.jsx)(n.li,{children:"Validate state structure before applying to store"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"storage-quota-exceeded",children:"Storage Quota Exceeded"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"})," ",(0,r.jsx)(n.code,{children:"QuotaExceededError"})," thrown when saving state."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Solutions:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Reduce element count or complexity"}),"\n",(0,r.jsx)(n.li,{children:"Implement data compression (e.g., lz-string)"}),"\n",(0,r.jsx)(n.li,{children:"Switch to IndexedDB for larger storage capacity"}),"\n",(0,r.jsx)(n.li,{children:"Prompt user to export/download and reset state"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"lost-data-after-browser-update",children:"Lost Data After Browser Update"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"})," State lost after browser or app update."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Solutions:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Always provide export/download functionality as backup"}),"\n",(0,r.jsx)(n.li,{children:"Implement robust migration system for version changes"}),"\n",(0,r.jsx)(n.li,{children:"Consider server-side storage for critical data"}),"\n",(0,r.jsx)(n.li,{children:"Add version detection and migration fallback"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"../api/canvas-store",children:"Canvas Store"})," - Store architecture and slices"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/ttpe/docs/docs/features/undo-redo",children:"Undo/Redo"})," - History management (not persisted)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/ttpe/docs/docs/architecture/overview#persistence-strategy",children:"State Management"})," - Persistence architecture"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/ttpe/docs/docs/app-structure/file-panel",children:"File Panel"})," - Save/Load UI controls"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/ttpe/docs/docs/architecture/overview#versioning--migration",children:"Versioning & Migration"})," - Migration strategies"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/pmndrs/zustand#persist-middleware",children:"Zustand Persist Middleware"})," - Official documentation"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>o});var t=s(6540);const r={},i=t.createContext(r);function a(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);